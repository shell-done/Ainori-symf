<?php

namespace BackOfficeBundle\Repository;

use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\JsonResponse;

use BackOfficeBundle\Entity\Trajet;
use BackOfficeBundle\Entity\Utilisateur;

use \Datetime;

/**
 * CovoiturageRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CovoiturageRepository extends \Doctrine\ORM\EntityRepository {

    public function getCo2EconomyByMonth() {
        $now = new DateTime(); 

        $co2SavedByMonth = [];

        for($i=1; $i<=12; $i++) {
            $em = $this->createQueryBuilder("covoit")
                ->select("sum(co2.valCo2)")
                ->innerJoin("covoit.co2", "co2")
                ->innerJoin("covoit.trajet", "trajet")
                ->innerJoin("trajet.typeTrajet", "type")
                ->where("type.typeTrajet = 'Ponctuel'")
                ->andWhere("trajet.dateDepart BETWEEN :start AND :end")
                ->andWhere("co2.actif = true")
                ->setParameter("start", $now->format("Y-$i-1"))
                ->setParameter("end", $now->format("Y-$i-t"))
                ->getQuery();

            $res = $em->getSingleScalarResult();

            if(!$res)
                $res = 0;

            array_push($co2SavedByMonth, number_format($res, 1));
        }

        return $co2SavedByMonth;
    }

    public function getCovoiturageOfTrajet($trajet) {
        $em = $this->createQueryBuilder("covoit")
            ->select(["covoit", "trajet"])
            ->innerJoin("covoit.trajet", "trajet")
            ->where("trajet = :trajet")
            ->setParameter("trajet", $trajet)
            ->getQuery();

        return $em->getResult();
    }

    public function getCovoituragesUtilisateur($id, $hydrated = false) {
        $em = $this->createQueryBuilder("covoit")
            ->select(["covoit", "t", "u"])
            ->innerJoin("covoit.trajet", "t")
            ->innerJoin("covoit.utilisateur", "u")
            ->where("u.id = :id")
            ->setParameter("id", $id)
            ->getQuery();

        if($hydrated)
            return $em->getArrayResult();

        return $em->getResult();
    }

    public function getCovoitsAsConducteur($id, $hydrated = false) {
        $em = $this->createQueryBuilder("c")
            ->select(["c", "t", "villeD", "villeA", "typeT", "typeC"])
            ->innerJoin("c.trajet", "t")
            ->innerJoin("t.villeDepart", "villeD")
            ->innerJoin("t.villeArrivee", "villeA")
            ->innerJoin("t.typeTrajet", "typeT")
            ->innerJoin("c.typeCovoit", "typeC")
            ->innerJoin("c.utilisateur", "u")
            ->where("typeC.type = 'Conducteur'")
            ->where("u.id = :id")
            ->setParameter("id", $id)
            ->getQuery();

        if($hydrated)
            return $em->getArrayResult();
        
        return $em->getResult();
    }

}
